---
title: "Project: Telco Customer Churn"
author: "Sona Nathani"
date: "14th May 2019"
output:
  prettydoc::html_pretty:
    df_print: paged
    highlight: github
    theme: cayman
    toc: yes
  html_document:
    code_download: yes
    df_print: paged
    theme: united
    toc: yes
---


```{r setup, include=FALSE}
## initial settings
knitr::opts_chunk$set(comment=NA, echo=FALSE, error = TRUE, cache=FALSE, message=FALSE, warning=FALSE)

## width to use when printing tables etc.
options(width = 600)
library(dplyr)
library(radiant)
library(lubridate)
library(ggplot2)
library(ROCR)
library(corrplot)
library(MASS) 
library(cowplot)
library(plyr)
library(gridExtra)
library(grid)
## make all required libraries available by loading radiant package if needed
if (!"package:radiant" %in% search())
  suppressMessages(suppressWarnings(library(radiant)))
library(prettydoc)

```


```{r}
## if you are planning to use data transformation commands generated by radiant please uncomment 
## the line below. Radiant stores all datasets in a list called r_data (e.g., r_data[["tuango"]])
if (!exists("r_environment")) r_data <- list()

# if (exists("r_data")) rm(r_data)

Telco <- read.csv("Telco-Customer-Churn.csv")
# Clients <- read.csv("Clients.csv")

```

### Data Exploration/Preparation

#### Telco Customer Churn Data
Here are the sample records from the dataset. 
```{r }
Telco[1:10,]
```
Structure of the dataset: 
```{r}
str(Telco)
sapply(Telco, function(x) sum(is.na(x)))
 Telco <- Telco[complete.cases(Telco), ]
```
```{r}
cols_recode1 <- c(10:15)
for(i in 1:ncol(Telco[,cols_recode1])) {
        Telco[,cols_recode1][,i] <- as.factor(mapvalues
                                              (Telco[,cols_recode1][,i], from =c("No internet service"),to=c("No")))
}
Telco$MultipleLines <- as.factor(mapvalues(Telco$MultipleLines, 
                                           from=c("No phone service"),
                                           to=c("No")))
#summary(Telco$MultipleLines)
Telco$SeniorCitizen <- as.factor(mapvalues(Telco$SeniorCitizen,
                                      from=c("0","1"),
                                      to=c("No", "Yes")))
#summary(Telco$SeniorCitizen)
Telco$customerID <- NULL

```



```{r}
#Correlation between numeric variables
numeric.var <- sapply(Telco, is.numeric)
corr.matrix <- cor(Telco[,numeric.var])
corrplot(corr.matrix, main="\n\n Correlation Plot for Numerical Variables", method="number")
```



```{r}
#Telco$TotalCharges <- NULL
```

### Proportion comparision of categorical variables

```{r, fig.width=35, fig.height=35,fig.align='center'}
#Approx 24% of female custorms churn on an average
prop1 <- compare_props(dataset = "Telco",var1 = "gender", var2 = "Churn", levs = "Yes", alternative = "less", adjust = "bonf")
plot1 <- plot(prop1, plots = "bar", custom = TRUE) + labs(x = "Gender") + labs(y = "Proportion of Churn") 

prop2 <- compare_props(dataset = "Telco",var1 = "SeniorCitizen", var2 = "Churn", levs = "Yes", alternative = "less", adjust = "bonf")
plot2 <- plot(prop2, plots = "bar", custom = TRUE)  + labs(x = "Senior Citizen") + labs(y= "Proportion of Churn")

prop3 <- compare_props(dataset = "Telco",var1 = "Partner", var2 = "Churn", levs = "Yes", alternative = "less", adjust = "bonf")
plot3 <- plot(prop3, plots = "bar", custom = TRUE) + labs(y = "Proportion of Churn") 

prop4 <- compare_props(dataset = "Telco",var1 = "Dependents", var2 = "Churn", levs = "Yes", alternative = "less", adjust = "bonf")
plot4 <- plot(prop4, plots = "bar", custom = TRUE) + labs(y = "Proportion of Churn") 

prop5 <- compare_props(dataset = "Telco",var1 = "PhoneService", var2 = "Churn", levs = "Yes", alternative = "less", adjust = "bonf")
plot5 <- plot(prop5, plots = "bar", custom = TRUE) + labs(y = "Proportion of Churn") 

prop6 <- compare_props(dataset = "Telco",var1 = "MultipleLines", var2 = "Churn", levs = "Yes", alternative = "less", adjust = "bonf")
plot6 <- plot(prop6, plots = "bar", custom = TRUE)+ labs(y = "Proportion of Churn") 

prop7 <- compare_props(dataset = "Telco",var1 = "InternetService", var2 = "Churn", levs = "Yes", alternative = "less", adjust = "bonf")
plot7 <- plot(prop7, plots = "bar", custom = TRUE)+ labs(y = "Proportion of Churn") 

prop8 <- compare_props(dataset = "Telco",var1 = "OnlineSecurity", var2 = "Churn", levs = "Yes", alternative = "less", adjust = "bonf")
plot8 <- plot(prop8, plots = "bar", custom = TRUE)+ labs(y = "Proportion of Churn") 

prop9 <- compare_props(dataset = "Telco",var1 = "OnlineBackup", var2 = "Churn", levs = "Yes", alternative = "less", adjust = "bonf")
plot9 <- plot(prop9, plots = "bar", custom = TRUE)+ labs(y = "Proportion of Churn") 

prop10 <- compare_props(dataset = "Telco",var1 = "DeviceProtection", var2 = "Churn", levs = "Yes", alternative = "less", adjust = "bonf")
plot10 <- plot(prop10, plots = "bar", custom = TRUE)+ labs(y = "Proportion of Churn") 

prop11 <- compare_props(dataset = "Telco",var1 = "TechSupport", var2 = "Churn", levs = "Yes", alternative = "less", adjust = "bonf")
plot11 <- plot(prop11, plots = "bar", custom = TRUE)+ labs(y = "Proportion of Churn") 

prop12 <- compare_props(dataset = "Telco",var1 = "StreamingTV", var2 = "Churn", levs = "Yes", alternative = "less", adjust = "bonf")
plot12 <- plot(prop12, plots = "bar", custom = TRUE)+ labs(y = "Proportion of Churn") 

prop13 <- compare_props(dataset = "Telco",var1 = "StreamingMovies", var2 = "Churn", levs = "Yes", alternative = "less", adjust = "bonf")
plot13 <- plot(prop13, plots = "bar", custom = TRUE)+ labs(y = "Proportion of Churn") 

prop14 <- compare_props(dataset = "Telco",var1 = "Contract", var2 = "Churn", levs = "Yes", alternative = "less", adjust = "bonf")
plot14 <- plot(prop14, plots = "bar", custom = TRUE)+ labs(y = "Proportion of Churn") 

prop15 <- compare_props(dataset = "Telco",var1 = "PaperlessBilling", var2 = "Churn", levs = "Yes", alternative = "less", adjust = "bonf")
plot15 <- plot(prop15, plots = "bar", custom = TRUE)+ labs(y = "Proportion of Churn") + 
  theme(plot.title = element_text(size = 12, face = "bold") , legend.title=element_text(size=30) , legend.text=element_text(size=20))

prop16 <- compare_props(dataset = "Telco",var1 = "PaymentMethod", var2 = "Churn", levs = "Yes", alternative = "less", adjust = "bonf")
plot16 <- plot(prop16, plots = "bar", custom = TRUE)+ labs(y = "Proportion of Churn") + theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  theme_bw() +   
  theme(legend.text=element_text(element_text(size=17)))

grid.arrange(plot1,plot2,plot3,plot4,plot5,plot6,plot7,plot8,plot9,plot10,plot11,plot12,plot13,plot14,plot15,plot16, ncol=3,nrow=6)
```


```{r}
Churn_Gender = table(Telco$Churn, Telco$gender) 
chisq.test(Churn_Gender)
Churn_SeniorCitizen = table(Telco$Churn, Telco$SeniorCitizen) 
chisq.test(Churn_SeniorCitizen)
Churn_Partner = table(Telco$Churn, Telco$Partner) 
chisq.test(Churn_Partner)
Churn_Dependents = table(Telco$Churn, Telco$Dependents) 
chisq.test(Churn_Dependents)
Churn_PhoneService = table(Telco$Churn, Telco$PhoneService) 
chisq.test(Churn_PhoneService)
Churn_MultipleLines = table(Telco$Churn, Telco$MultipleLines) 
chisq.test(Churn_MultipleLines)
Churn_InternetService = table(Telco$Churn, Telco$InternetService) 
chisq.test(Churn_InternetService)
Churn_OnlineSecurity = table(Telco$Churn, Telco$OnlineSecurity) 
chisq.test(Churn_OnlineSecurity)
Churn_OnlineBackup = table(Telco$Churn, Telco$OnlineBackup) 
chisq.test(Churn_OnlineBackup)
Churn_DeviceProtection = table(Telco$Churn, Telco$DeviceProtection) 
chisq.test(Churn_DeviceProtection)
Churn_TechSupport = table(Telco$Churn, Telco$TechSupport) 
chisq.test(Churn_TechSupport)
Churn_StreamingTV = table(Telco$Churn, Telco$StreamingTV) 
chisq.test(Churn_StreamingTV)
Churn_StreamingMovies = table(Telco$Churn, Telco$StreamingMovies) 
chisq.test(Churn_StreamingMovies)
Churn_Contract = table(Telco$Churn, Telco$Contract) 
chisq.test(Churn_Contract)
Churn_PaperlessBilling = table(Telco$Churn, Telco$PaperlessBilling) 
chisq.test(Churn_PaperlessBilling)
Churn_PaymentMethod = table(Telco$Churn, Telco$PaymentMethod) 
chisq.test(Churn_PaymentMethod)

# corr1 <- corrplot(chisq.test(Churn_Gender)$residuals, is.cor = FALSE)
# corr2 <- corrplot(chisq.test(Churn_SeniorCitizen)$residuals, is.cor = FALSE)
# corr3 <- corrplot(chisq.test(Churn_Partner)$residuals, is.cor = FALSE)
# corr4 <- corrplot(chisq.test(Churn_Dependents)$residuals, is.cor = FALSE)
# corr5 <- corrplot(chisq.test(Churn_PhoneService)$residuals, is.cor = FALSE)
# corr6 <- corrplot(chisq.test(Churn_MultipleLines)$residuals, is.cor = FALSE)
# corr7 <- corrplot(chisq.test(Churn_InternetService)$residuals, is.cor = FALSE)
# corr8 <- corrplot(chisq.test(Churn_OnlineSecurity)$residuals, is.cor = FALSE)
# corr9 <- corrplot(chisq.test(Churn_OnlineBackup)$residuals, is.cor = FALSE)
# corr10 <- corrplot(chisq.test(Churn_DeviceProtection)$residuals, is.cor = FALSE)
# corr11 <- corrplot(chisq.test(Churn_TechSupport)$residuals, is.cor = FALSE)
# corr12 <- corrplot(chisq.test(Churn_StreamingTV)$residuals, is.cor = FALSE)
# corr13 <- corrplot(chisq.test(Churn_StreamingMovies)$residuals, is.cor = FALSE)
# corr14 <- corrplot(chisq.test(Churn_Contract)$residuals, is.cor = FALSE)
# corr15 <- corrplot(chisq.test(Churn_PaperlessBilling)$residuals, is.cor = FALSE)
# corr16 <- corrplot(chisq.test(Churn_PaymentMethod)$residuals, is.cor = FALSE)

#grid.arrange(corr1, corr2, ncol=2,nrow=1)
```

#### Histogram of Tenure and Monthly Charges
```{r,fig.width=15, fig.height=6,fig.align='center'}
  p1 <- ggplot(Telco,aes(x=tenure,fill=Churn)) + geom_histogram() + 
  facet_wrap(~Churn) + xlim(0,75)+ 
  theme(legend.position="none")+
  theme_bw() +
  theme(legend.text=element_text(size=rel(0.5)))

  p2 <- ggplot(Telco,aes(x=MonthlyCharges,fill=Churn)) + geom_histogram() + 
  facet_wrap(~Churn) + xlim(0,125)+
  theme(legend.position="none")+
  theme_bw() +
  theme(legend.text=element_text(size=rel(0.5)))

  grid.arrange(p1, p2, ncol=2)

```



#### Density Plot of Tenure and Monthly Charges

```{r,fig.width=15, fig.height=6,fig.align='center'}
p11 <- Telco %>%
  ggplot(aes(x=tenure,fill=Churn)) + geom_density(alpha=0.2)+xlab('Tenure (min.)') + ylab('Proportion of Churn') 

p12 <- Telco %>%
  ggplot(aes(x=MonthlyCharges,fill=Churn)) + geom_density(alpha=0.2)+xlab('Monthly Charges (min.)') + ylab('Proportion of Churn') 

grid.arrange(p11, p12, ncol=2)

```


#### Based on the above Density Plots, Tenure and Monthly Charges is categorized into relevent groups.The comparision plots to show the proportion of Churn in each group is shown below:

```{r,fig.width=15, fig.height=6,fig.align='center'}

Telco$TenureBucket=ifelse(Telco$tenure<=20,"1) 0-20 Months",
                   ifelse(Telco$tenure <40,"2) 20-40 Months",
                    "3) >40 Months"))

Telco$MonthlyChargesBucket=ifelse(Telco$MonthlyCharges<=35,"1) Charges <$35",
                   ifelse(Telco$MonthlyCharges <70,"2) Charges $35 - $70",
                   "3) Charges >$70"))

prop17 <- compare_props(dataset = "Telco",var1 = "TenureBucket", var2 = "Churn", levs = "Yes", alternative = "less", adjust = "bonf")
plot17 <- plot(prop17, plots = "bar", custom = TRUE)+ labs(y = "Proportion of Churn") 

prop18 <- compare_props(dataset = "Telco",var1 = "MonthlyChargesBucket", var2 = "Churn", levs = "Yes", alternative = "less", adjust = "bonf")
plot18 <- plot(prop18, plots = "bar", custom = TRUE)+ labs(y = "Proportion of Churn") 

grid.arrange(plot17, plot18, ncol=2,nrow=1)
```



```{r,fig.width=25}
set.seed(1234)
d <- sort(sample(nrow(Telco), nrow(Telco)*0.7))
dev <- Telco[d,]
val <- Telco[-d,]

dev$training <- 1
val$training <- 0
model.customers <- rbind(dev,val)

library(dplyr)
eval_dat <- model.customers[,c("Churn","training")]
#str(Telco)
rvar <- "Churn"
evar <- c("SeniorCitizen", "Partner", "Dependents", "InternetService", "OnlineSecurity",
          "OnlineBackup","DeviceProtection","TechSupport","StreamingTV","StreamingMovies","Contract",
          "PaperlessBilling","TenureBucket","MonthlyChargesBucket")
lev <- "Yes"
result <- logistic(dev, rvar = rvar, evar = evar, lev = lev)
```

#### Logistic Regression Output

```{r}
#summary(result, sum_check = c("vif", "confint", "odds"))
summary(result, sum_check = c("confint", "odds"))
pred <- predict(result, pred_data = model.customers)
eval_dat$logit <- pred[["Prediction"]]
```



```{r}

####### Model Performance
#### AUC curve - Logistic Regression
prob.dev <- eval_dat[eval_dat$training == 1,]$logit # predicted probabilities
pred.dev <- prediction(prob.dev,eval_dat[eval_dat$training == 1,]$Churn)
perf.dev <- performance(pred.dev,measure = "tpr",x.measure = "fpr")

prob.val <- eval_dat[eval_dat$training == 0,]$logit # predicted probabilities
pred.val <- prediction(prob.val,eval_dat[eval_dat$training == 0,]$Churn)
perf.val <- performance(pred.val,measure = "tpr",x.measure = "fpr")
```

###AUC Curve 

AUC is low, but this can be improved if we explore and add new variables that could determine customers who are likely to churn.

```{r}
plot(perf.dev, col ="red")
plot(perf.val, add = TRUE, colorize = TRUE)

auc.dev <- performance(pred.dev, measure = "auc")
auc.logit.dev <- auc.dev@y.values[[1]]

auc.val <- performance(pred.val, measure = "auc")
auc.logit.val <- auc.val@y.values[[1]]

```

```{r}
#######confusion matrix##
conf_data<-as.data.frame(cbind(prob.dev, eval_dat[eval_dat$training == 1,]$Churn))
m1<-table(conf_data$prob.dev>mean(eval_dat[eval_dat$training == 1,]$Churn =="Yes"),eval_dat[eval_dat$training == 1,]$Churn)
accuracy.logistic.dev <-(m1[1,1]+m1[2,2])/(m1[1,1]+m1[1,2]+m1[2,2]+m1[2,1])

#######confusion matrix##
conf_data<-as.data.frame(cbind(prob.val, eval_dat[eval_dat$training == 0,]$Churn))
# table(conf_data$prob.val>mean(eval_dat$settled.accounts.any=="Settled acct"),eval_dat[eval_dat$training == 0,]$settled.accounts.any)
m2<-table(conf_data$prob.val>mean(eval_dat$Churn=="Yes"),eval_dat[eval_dat$training == 0,]$Churn)
accuracy.logistic.val <-(m2[1,1]+m2[2,2])/(m2[1,1]+m2[1,2]+m2[2,2]+m2[2,1])
```

### Logistic Regression output

- **`r formatnr(auc.logit.dev, dec=2)`** is the AUC for the development sample 
- **`r formatnr(auc.logit.val, dec=2)`** is the AUC for the validation sample
- **`r formatnr(accuracy.logistic.dev, dec=2)`** is the accuracy of the development sample 
- **`r formatnr(accuracy.logistic.val, dec=2)`** is the accuracy of the validation sample
